# bring your own key (byok) implementation plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:subagent-driven-development to implement this plan task-by-task.

**goal:** replace centralized auth with a user-provided client id/secret flow, enabling persistent tokens and higher rate limits. include guided onboarding.

**architecture:**
1.  update settings to store `spotifyClientId` and `spotifyClientSecret`.
2.  implement `SpotifyAuthService` to use `client_credentials` (or `authorization_code` with custom redirect) flow directly from the extension.
    *   *Constraint:* Browser extensions cannot keep `client_secret` safe if embedded. Since the user provides it, it's "safe enough" for personal use, but `client_credentials` only gives public data access. We need user data access (playlists).
    *   *Solution:* We still need PKCE or Implicit Grant. Since the user provides the Client ID, we can use **Implicit Grant** (token in URL) or **Authorization Code with PKCE**.
    *   *Redirection:* The redirect URI must be `https://<extension-id>.chromiumapp.org/` or similar. The user must add this to their Spotify App Dashboard.
3.  build an onboarding UI in the popup that blocks usage until keys are set.
4.  add a "Help / Guide" section with placeholders for screenshots.

**tech stack:** react, typescript, chrome.identity

### Task 1: Update Settings & Storage

**Files:**
- Modify: `tuneport-extension/src/popup/index.tsx` (SettingsState)
- Modify: `tuneport-extension/src/config/defaults.ts`

**Step 1: Write failing test**
(Skipping strict TDD for interfaces, but will verify via compilation)

**Step 2: Update Interface**
Add `spotifyClientId` and `spotifyClientSecret` to `SettingsState`.
Add `redirectUri` field (read-only, computed) for display.

**Step 3: Commit**
```bash
git add tuneport-extension/src/popup/index.tsx
git commit -m "feat: add client id fields to settings"
```

### Task 2: Implement Direct PKCE Auth

**Files:**
- Modify: `tuneport-extension/src/services/SpotifyAuthService.ts`
- Modify: `tuneport-extension/src/background/index.ts`

**Step 1: Refactor Auth Service**
Remove hardcoded endpoints.
Implement `authorizeUser(clientId)` using `chrome.identity.launchWebAuthFlow`.
Use PKCE (generate code verifier/challenge).
Redirect URI: `chrome.identity.getRedirectURL()`.

**Step 2: Token Exchange**
Implement `exchangeCodeForToken` using the user-provided Client ID (and Secret if we use standard flow, or just PKCE if public client). *Recommendation: PKCE is cleaner for extensions, no secret needed.*
**Decision:** We will use **PKCE** (Proof Key for Code Exchange). User only needs to provide **Client ID**. Secret is not required for PKCE on Spotify. This simplifies setup!

**Step 3: Commit**
```bash
git add tuneport-extension/src/services/SpotifyAuthService.ts
git commit -m "feat: implement pkce auth with dynamic client id"
```

### Task 3: Build Onboarding UI

**Files:**
- Modify: `tuneport-extension/src/popup/index.tsx`
- Create: `tuneport-extension/src/components/Onboarding.tsx` (or inline)

**Step 1: Create Setup Screen**
If `!settings.spotifyClientId`, show "Welcome to TunePort".
Input field for `Client ID`.
Display the `Redirect URI` they need to copy-paste.
"How to get this?" accordion/modal with placeholder image areas.

**Step 2: Integrate into Main Flow**
Block main UI until setup is complete.

**Step 3: Commit**
```bash
git add tuneport-extension/src/popup/index.tsx
git commit -m "feat: add byok onboarding ui"
```

### Task 4: Documentation & Polish

**Files:**
- Modify: `README.md`
- Create: `docs/setup-guide.md`

**Step 1: Write Guide**
Step-by-step:
1. Go to developer.spotify.com
2. Create App
3. Copy Client ID
4. Add Redirect URI (copy from extension)
5. Save

**Step 2: Commit**
```bash
git add README.md
git commit -m "docs: add setup instructions"
```
